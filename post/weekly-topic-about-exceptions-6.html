<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nico 0.5.2">
    <meta name="theme" content="KISS 0.1">
    <title>每周异常：第 6期，JavaScript 异常监控脚本引发的 JavaScript 异常 - 闲耘™.博客</title>
    <link rel="alternate" type="application/rss+xml" href="https://hotoo.github.io/blog//feed.xml" title="闲耘™.博客" />
    <link rel="stylesheet" href="../static/syntax.css" />
    <link type="text/css" rel="stylesheet" href="../static/template.css" />
  </head>
  <body>
  <div id="wrapper">
    <header class="navigation" role="navigation">
      <!--<a class="home" href="../">闲耘™.博客</a>-->
      <div style="float:right;">
        <form action="/blog/search.html">
          <input type="text" name="q" autocomplete="off" />
          <input type="submit" value="搜索" />
        </form>
      </div>
      <nav class="menu">
        <ul>
          <li class="first"><a href="https://hotoo.github.io/"
            title="Home">Home</a></li>
          <li class=" actived"><a href="/blog/"
            title="Blog">Blog</a></li>
          <li class=""><a href="https://hotoo.github.io/wiki/"
            title="Wiki">Wiki</a></li>
          <li class=""><a href="https://hotoo.github.io/wiki/Vim.html"
            title="Vim">Vim</a></li>
          <li class=""><a href="https://hotoo.github.io/twitter/"
            title="Twitter">Twitter</a></li>
          <li class="last"><a href="https://github.com/hotoo"
            title="Project">Project</a></li>
        </ul>
      </nav>
    </header>

<div id="container">
  <div id="content" class="document">
<div class="hentry">
  <h1 class="entry-title">每周异常：第 6期，JavaScript 异常监控脚本引发的 JavaScript 异常</h1>
  <div class="entry-content"><h2 id="背景">背景</h2><p>早上收到比较重要的用户反馈说某个重要的系统的页面在 IE 浏览器中卡死，无法继续。</p>
<p><img src="https://f.cloud.github.com/assets/143572/1007567/5214e9b4-0b0b-11e3-8d43-07d34947d198.png" alt="2013-08-22 5 14 01">
<img src="https://f.cloud.github.com/assets/143572/1007568/523e63de-0b0b-11e3-85bd-b3adee635aef.png" alt="2013-08-22 5 14 25"></p>
<p>问题很严重。</p>
<p>系统比较特殊复杂，不是一般人能登录进去的。找到对应同学在小概率重现的情况下终于拿到了第一手的问题源码。</p>
<h2 id="分析">分析</h2><p>修改配置和采样率之后在本地跑起来，发现在 IE6 里非常有问题。</p>
<ol>
<li>性能这么大的问题，首先想到的是页面中大面积扫描 HTML 代码的部分，但是注释掉这部分仍然没有改善。</li>
<li>再次把整个回调处理函数注释掉，仍然没有改善。</li>
<li>直接把加载后置脚本的 seajs.use 注释掉之后，终于没问题了。（坑爹的缓存问题就不说了，好久之后才发现，都是泪~）</li>
<li>这么看来有两种可能：<ol>
<li>模块本身有性能问题。</li>
<li>seajs 性能有问题（这个问题页面目前使用的 1.3.1）</li>
</ol>
</li>
<li>首先考虑自身的问题。return 整个 factory，性能无问题，因此不是模块过多导致 seajs 性能问题。</li>
<li><p>逐步修改 return 位置（其实可以打断点），终于发现问题出在 <a href="https://github.com/totorojs/monitor.js/blob/2.2.0/src/monitor.js#L23">初始化事件绑定函数部分</a>。</p>
<p><!-- baseline:11 --></p><div class="highlight"><div class="codes"><div class="code"><pre><code class="javascript"><span class="hljs-comment">// 避免未引用先行脚本抛出异常。</span>
<span class="hljs-keyword">if</span>(!win.monitor){
  M = win.monitor = {};
  M._DATAS = [];
  M._EVENTS = [];
}

<span class="hljs-keyword">var</span> _events = M._EVENTS;
<span class="hljs-keyword">var</span> _evt = <span class="hljs-keyword">new</span> Events();
M.on = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, handler</span>)</span>{
  _evt.on(evt, handler);
};
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>,l=_events.length; i&lt;l; i++){
  M.on(_events[i][<span class="hljs-number">0</span>], _events[i][<span class="hljs-number">1</span>]);
}</code></pre></div><pre class="line"><a name="L1-1" href="#L1-1">1</a>
<a name="L1-2" href="#L1-2">2</a>
<a name="L1-3" href="#L1-3">3</a>
<a name="L1-4" href="#L1-4">4</a>
<a name="L1-5" href="#L1-5">5</a>
<a name="L1-6" href="#L1-6">6</a>
<a name="L1-7" href="#L1-7">7</a>
<a name="L1-8" href="#L1-8">8</a>
<a name="L1-9" href="#L1-9">9</a>
<a name="L1-10" href="#L1-10">10</a>
<a name="L1-11" href="#L1-11">11</a>
<a name="L1-12" href="#L1-12">12</a>
<a name="L1-13" href="#L1-13">13</a>
<a name="L1-14" href="#L1-14">14</a>
<a name="L1-15" href="#L1-15">15</a></pre></div></div></li>
<li>此时 _events = undefined。访问 undefined.length 或其他属性会导致浏览器挂起？ IE6 还有这样的坑？</li>
<li>新建一个最小代码的新页面，直接 <code>script[src]</code> 引入这个脚本没有问题，IE 会正常的抛出异常，不会挂起。</li>
<li>动态创建 script 插入脚本，仍然不会挂起，正常抛出异常。</li>
<li>奇怪。各种尝试，最终加入前置脚本后在这个最小重现代码中重现了异常。</li>
<li>然后发现是在 window.onerror 中出现问题。</li>
<li>继续发现的模拟调用栈信息的算法出现问题。</li>
</ol>
<p>cmd 模块在 define 的 factory 中本身抛出异常，会被前置脚本的 window.onerror 捕获，捕获过程中尝试 <a href="https://github.com/totorojs/monitor.js/blob/2.2.0/src/seer.js#L66">还原函数调用栈</a>。模拟还原调用栈信息是通过 arguments.callee.caller 向上递归，直到找到函数调用的发起者。但是悲剧的是发现 seajs 这个调用栈是无穷无尽的：</p><div class="highlight"><div class="codes"><div class="code"><pre>at function(require, exports, module)
at function runInModuleContext(fn, module)
at function()
at function(uri)
at function(item, i, arr)
at function(arr, fn)  ........-
at function(arr, fn)          |
at function()                 |
at function preload(callback) |
at function()                 |
at function cb(module)        |
at function onFetched()       |
at function(fn)       ........-
at function(arr, fn)    ..........-
at function(arr, fn)              | 循环往复
at function()                     |
at function preload(callback)     |
at function()                     |
at function cb(module)            |
at function onFetched()           |
at function(fn)         ..........-
at function(arr, fn) .........-
at function(arr, fn)          | 无穷尽也
at function()                 |
at function preload(callback) |
at function()                 |
at function cb(module)        |
at function onFetched()       |
at function(fn)         ......-</pre></div><pre class="line"><a name="L2-1" href="#L2-1">1</a>
<a name="L2-2" href="#L2-2">2</a>
<a name="L2-3" href="#L2-3">3</a>
<a name="L2-4" href="#L2-4">4</a>
<a name="L2-5" href="#L2-5">5</a>
<a name="L2-6" href="#L2-6">6</a>
<a name="L2-7" href="#L2-7">7</a>
<a name="L2-8" href="#L2-8">8</a>
<a name="L2-9" href="#L2-9">9</a>
<a name="L2-10" href="#L2-10">10</a>
<a name="L2-11" href="#L2-11">11</a>
<a name="L2-12" href="#L2-12">12</a>
<a name="L2-13" href="#L2-13">13</a>
<a name="L2-14" href="#L2-14">14</a>
<a name="L2-15" href="#L2-15">15</a>
<a name="L2-16" href="#L2-16">16</a>
<a name="L2-17" href="#L2-17">17</a>
<a name="L2-18" href="#L2-18">18</a>
<a name="L2-19" href="#L2-19">19</a>
<a name="L2-20" href="#L2-20">20</a>
<a name="L2-21" href="#L2-21">21</a>
<a name="L2-22" href="#L2-22">22</a>
<a name="L2-23" href="#L2-23">23</a>
<a name="L2-24" href="#L2-24">24</a>
<a name="L2-25" href="#L2-25">25</a>
<a name="L2-26" href="#L2-26">26</a>
<a name="L2-27" href="#L2-27">27</a>
<a name="L2-28" href="#L2-28">28</a>
<a name="L2-29" href="#L2-29">29</a></pre></div></div><p>这也就是为什么用户的浏览器会挂起的原因。</p>
<hr>
<h3 id="小结">小结</h3><p>用户浏览器被挂起，最终发现：</p>
<ul>
<li>不是扫描整个文档的性能问题。</li>
<li>不是 seajs 加载多个模块的性能问题。</li>
<li>主要不是 cmd define 中报错的问题。</li>
<li>不是 window.onerror 捕获异常的问题。</li>
<li>而是获取异常函数调用栈出现无限循环链的问题，</li>
<li>这其实是 IE 的问题。</li>
<li>好吧，最终还是我的问题。</li>
</ul>
<h2 id="监控脚本自身的-cmd-模块定义的异常是怎么出现的？">监控脚本自身的 cmd 模块定义的异常是怎么出现的？</h2><p>monitor 2.2.0 新增了 <a href="https://github.com/totorojs/monitor.js/issues/18">事件机制</a>，支持监控任意的自定义数据。</p>
<p>其中在前置脚本中新增了 <code>monitor.on()</code> 方法，将自定义事件处理函数临时存储在 <code>monitor._EVENTS</code> 属性中 <a href="https://github.com/totorojs/monitor.js/blob/2.2.0/src/seer.js#L18">参考代码</a> 。后置脚本加载完成后，会复写 <code>monitor.on()</code> 方法，并将之前用户自定义事件处理函数绑定到对应事件，以使事件机制生效。</p>
<p>这些理论上都是非常不错的设计思路。</p>
<p>但是现实太残酷，全站公共区域被实际部署的情况有太复杂：</p>
<ol>
<li>有些系统没有完全引入前置脚本。</li>
<li>有些系统仍然引用的老版本的前置脚本。</li>
</ol>
<p>后置脚本对于后面的这个场景没有考虑到，因此这段保险栓未能正确执行导致后续脚本报错。</p>
<h2 id="为什么这个异常会到生产环境？">为什么这个异常会到生产环境？</h2><p>都是我的错，没有考虑周全。没有考虑到这种特殊的系统部署环境，而且我也从来不能进去实际体验、验证。</p>
<h2 id="如何处理这个异常？">如何处理这个异常？</h2><ol>
<li>作为全站全局运行的代码，要详细评估考虑到各种系统变态的部署环境。</li>
<li>打断循环调用栈<ol>
<li>限制监控的最大函数调用栈深度。</li>
<li>对于已经调用的栈，不再深入递归，或现在递归次数（待评估，实际项目存在正常的递归或多次调用的代码。）</li>
</ol>
</li>
</ol>
<h2 id="为什么-seajs-define-模块中报错会出现函数调用栈无限递归？">为什么 seajs define 模块中报错会出现函数调用栈无限递归？</h2><p>这是 seajs 1.3.1 的 BUG，更准确的说，可能是 IE6,7,8闭包的问题。参考： <a href="https://github.com/seajs/seajs/issues/911">https://github.com/seajs/seajs/issues/911</a></p>
</div>

  <footer class="entry-meta post clearfix">
    <span class="tags"><a href="../tag">Tags</a>:
 
      <a href="/tag/#每周异常">每周异常</a>
      
    </span>

    <time datetime="2013-08-22T00:00:00.000Z">
      <a href="../2013">2013年</a>08月22日
    </time>
  </footer>
    <section>
      <div id="disqus_thread"></div>
      <noscript>
        要查看或参与评论，请启用 JavaScript 支持。<br />
        Please enable JavaScript to view the <a href="https://github.com/hotoo/blog/issues">comments powered by Gitment.</a>
      </noscript>
    </section>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script type="text/javascript">
    
    var disqus_identifier = "weekly-topic-about-exceptions-6";
    

    var gitment = new Gitment({
      id: disqus_identifier, // 可选。默认为 location.href
      owner: 'hotoo',
      repo: 'blog',
      oauth: {
        client_id: '2ac185fc670562ffa0aa',
        client_secret: '248f4f2d70ed28b1e3e70113db27d46067a981a8',
      },
    })
    gitment.render('disqus_thread');

    // var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    // dsq.src = 'http://hotoo.disqus.com/embed.js';
    // (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  </script>
</div>
</div>

    <!-- Vimlike status bar -->
    <div id="status-bar">
        <span id="count"></span>
    </div>
</div>
<div id="helper-box"></div>
<div id="helper" tabindex="1">
    <table>
    <thead>
        <tr>
            <th colspan="2">Help</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th width="120">[count]gg</th>
            <td>跳转到第 [count] 行，默认第 1 行。</td>
        </tr>
        <tr>
            <th>[count]G</th>
            <td>跳转到第 [count] 行，默认最后一行。</td>
        </tr>
        <tr>
            <th>[count]j</th>
            <td>向下跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>[count]k</th>
            <td>向上跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>/</th>
            <td>开始搜索。按 &lt;Esc&gt; 退出。</td>
        </tr>
        <tr>
            <th>gh</th>
            <td>跳转到首页。</td>
        </tr>
        <tr>
            <th>gb</th>
            <td>跳转到博客首页。</td>
        </tr>
        <tr>
            <th>gw</th>
            <td>跳转到 Wiki 首页。</td>
        </tr>
        <tr>
            <th>gt</th>
            <td>跳转到我的 Twitter Profile 页。</td>
        </tr>
        <tr>
            <th>gp</th>
            <td>跳转到我的 Github Profile 页。</td>
        </tr>
        <tr>
            <th>?</th>
            <td>打开帮助。按 &lt;Esc&gt; 退出。</td>
        </tr>
    </tbody>
    </table>
</div>

<script type="text/javascript" src="/blog/static/js/Vimlike.js"></script>
<footer>
  <p><a rel="license" href="http://creativecommons.org/licenses/by/2.5/"><img
    alt="Creative Commons License" style="border-width: 0pt;"
    src="http://i.creativecommons.org/l/by/2.5/88x31.png" align="right"/></a>
  This work is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/2.5/">Creative
    Commons Attribution 2.5 Generic License</a>.<br/>
  Copyleft &copy; 2005-2017, Power by
  <a href="http://lab.lepture.com/nico/">nico@0.5.2</a>, Theme by 闲耘™(@hotoo).
  </p>
</footer>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2048484-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>