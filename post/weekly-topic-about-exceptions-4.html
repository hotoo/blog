<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nico 0.5.2">
    <meta name="theme" content="KISS 0.1">
    <title>每周异常：第 4期，如何避免客户端攻击造成的大量异常报警 - 闲耘™.博客</title>
    <link rel="alternate" type="application/rss+xml" href="http://blog.hotoo.me/feed.xml" title="闲耘™.博客" />
    <link rel="stylesheet" href="../static/syntax.css" />
    <link type="text/css" rel="stylesheet" href="../static/template.css" />
  </head>
  <body>
  <div id="wrapper">
    <header class="navigation" role="navigation">
      <!--<a class="home" href="../">闲耘™.博客</a>-->
      <div style="float:right;">
        <form action="/search.html">
          <input type="text" name="q" autocomplete="off" />
          <input type="submit" value="搜索" />
        </form>
      </div>
      <nav class="menu">
        <ul>
          <li class="first"><a href="http://hotoo.me/"
            title="Home">Home</a></li>
          <li class=" actived"><a href="/"
            title="Blog">Blog</a></li>
          <li class=""><a href="http://wiki.hotoo.me/"
            title="Wiki">Wiki</a></li>
          <li class=""><a href="http://wiki.hotoo.me/Vim.html"
            title="Vim">Vim</a></li>
          <li class=""><a href="http://twitter.hotoo.me/"
            title="Twitter">Twitter</a></li>
          <li class="last"><a href="https://github.com/hotoo"
            title="Project">Project</a></li>
        </ul>
      </nav>
    </header>

<div id="container">
  <div id="content" class="document">
<div class="hentry">
  <h1 class="entry-title">每周异常：第 4期，如何避免客户端攻击造成的大量异常报警</h1>
  <div class="entry-content"><p>在 JavaScript 异常监控过程中，发现有很多由于客户端连续攻击造成的大量异常，导致
监控系统报警。</p>
<p><img src="https://f.cloud.github.com/assets/143572/921735/fe39d910-ff04-11e2-93f2-ca5bb222be8f.png" alt="2013-08-07 9 58 37"></p>
<p>（图中大量不连续的波动，都是攻击造成的）</p>
<p>这种少量用户(UV)发起攻击造成的大量异常(PV)波动，不是我们实时监控需要关注的部分。
我们实时监控最重要的是要发现由于系统发布过程中，我们的发布的代码有问题导致大量
用户受影响而出现的波动（波形可能跟上图的每一个异常波形相似）。</p>
<p>理论上导致异常数据波动的场景包括：</p>
<ul>
<li>少量用户发起大量攻击。</li>
<li>大量用户同时涌入或离开。</li>
<li>发布问题代码影响到大量用户。</li>
</ul>
<p>少量用户发起大量攻击造成数据波动，是我们可以不必实时关注实时报警的部分。</p>
<p>大量用户同时涌入或离开造成的异常数量(PV)波动，也是我们无需实时关注的部分，
另外我们也可以通过异常率规避波动。</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>异常 PV</th>
<th>异常 UV</th>
<th>异常率(PV)</th>
<th>异常率(UV)</th>
</tr>
</thead>
<tbody>
<tr>
<td>攻击</td>
<td>波动</td>
<td>无波动</td>
<td>波动</td>
<td>无波动</td>
</tr>
<tr>
<td>涌入</td>
<td>波动</td>
<td>波动</td>
<td>无波动</td>
<td>无波动</td>
</tr>
<tr>
<td>发布</td>
<td>波动</td>
<td>波动</td>
<td>波动</td>
<td>波动</td>
</tr>
</tbody>
</table>
<p>注：</p>
<ul>
<li>异常率(PV) = 异常PV / 所在页面PV</li>
<li>异常率(UV) = 异常UV / 所在页面UV</li>
</ul>
<p>从上面的对照表可以看出，理论上我们只需要关注异常率(UV) 是否正常波动就可以了。</p>
<p>理想很性感，现实很骨感。</p>
<p>我们的数据仓库、数据分析系统对于实时 PV 有很强的处理能力，但是对于 UV 就感觉力有不逮。</p>
<p>起初想到在实时日志处理逻辑中使用缓存（伪代码）：</p><div class="highlight"><div class="codes"><div class="code"><pre><code class="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogParse</span>()</span>{

  <span class="hljs-keyword">var</span> user_cache = {};
  <span class="hljs-keyword">var</span> MINUTES_FORMAT = <span class="hljs-string">"YYYYMMDDHHmm"</span>;
  <span class="hljs-keyword">var</span> lastTime = moment().format(MINUTES_FORMAT);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">log</span>)</span>{
    <span class="hljs-comment">// PV 统计</span>

    <span class="hljs-keyword">var</span> now = moment().format(MINUTES_FORMAT);
    <span class="hljs-keyword">if</span>(now !== lastTime){
      user_cache = {};
      lastTime = now;
    }
    <span class="hljs-keyword">if</span>(user_cache.hasOwnProperty(user_id)){<span class="hljs-keyword">return</span>;}
    <span class="hljs-comment">// UV 统计</span>
  }

}</code></pre></div><pre class="line"><a name="L1-1" href="#L1-1">1</a>
<a name="L1-2" href="#L1-2">2</a>
<a name="L1-3" href="#L1-3">3</a>
<a name="L1-4" href="#L1-4">4</a>
<a name="L1-5" href="#L1-5">5</a>
<a name="L1-6" href="#L1-6">6</a>
<a name="L1-7" href="#L1-7">7</a>
<a name="L1-8" href="#L1-8">8</a>
<a name="L1-9" href="#L1-9">9</a>
<a name="L1-10" href="#L1-10">10</a>
<a name="L1-11" href="#L1-11">11</a>
<a name="L1-12" href="#L1-12">12</a>
<a name="L1-13" href="#L1-13">13</a>
<a name="L1-14" href="#L1-14">14</a>
<a name="L1-15" href="#L1-15">15</a>
<a name="L1-16" href="#L1-16">16</a>
<a name="L1-17" href="#L1-17">17</a>
<a name="L1-18" href="#L1-18">18</a>
<a name="L1-19" href="#L1-19">19</a></pre></div></div><ul>
<li>但是实时数据分析系统是分布式的，由多台服务器组成的集群同时处理日志，所以里面
的内部状态只有本机有效</li>
<li>另外更致命的是，实时数据分析系统是无状态的，下次执行会 new 新的 LogParser 实例，
同一台机器的状态也保证不了。</li>
</ul>
<p>于是我们又想到一种从客户端来标识用户的方法：</p>
<ol>
<li>客户端单位时间内同一个页面抛出的同一个异常，第一次打上 uv 标记。</li>
<li>数据处理时遇到 uv 标记的日志，同时统计算做一个异常 uv。</li>
</ol>
<p>由于客户端时间和服务端有时间差，每个客户端时间和服务端时间差也不一致，导致这种
方案会有稍大误差，但也基本能解决问题。</p>
<p>但是要在客户端打标记，则需要在客户端（cookie 或其他本地存储）记录每个异常
（url, file, line, message 相同被当作同一个异常）最后抛出的时间，每次抛出异常
都需要读写本地存储，稍嫌臃肿。</p>
<p>通过深入分析实际的攻击案例，发现攻击引发大量异常的场景中，客户端页面是不刷新或
重新访问的，都是直接在当前访问的页面执行上批量脚本。</p>
<p>因此我们可以使用局部变量，将当前访问的页面的每个异常最后抛出时间记录在内存中，
重新访问页面则重新开始记录。</p>
<p>这种方案对于防范攻击造成的大量异常非常有效；对于大量用户涌入引起的异常也有一定
效用，毕竟正常用户较少会频繁触发异常。</p>
<p>总之，通过这个方案，我们可以非常有效的实时监控异常波动，较少误报。</p>
<p>p.s. 这个想法是早上洗澡的时候想到的，还没开始实践。但是我信心满满写下这篇，
数据会来证明我是对的。</p>
<h2 id="续-on-2013-08-20">续 on 2013-08-20</h2><p>是时候结帐了。正好发布一天，大家看数据：</p>
<p><img src="https://f.cloud.github.com/assets/143572/991796/2e2038c2-096e-11e3-9008-e21d3b9e354a.png" alt="2013-08-20 3 55 10"></p>
<p>图中的灰色竖线是发布点，橙色是 JavaScript 异常，绿色是静态资源异常。</p>
<p>妈妈再也不用担心我的手机会收到误报的报警短信了。</p>
</div>

  <footer class="entry-meta post clearfix">
    <span class="tags"><a href="/tag">Tags</a>:
 
      <a href="/tag/#每周异常">每周异常</a>
      
    </span>

    <time datetime="2013-08-07T00:00:00.000Z">
      <a href="/2013">2013年</a>08月07日
    </time>
  </footer>
    <section>
      <div id="disqus_thread"></div>
      <noscript>
        要查看或参与评论，请启用 JavaScript 支持。<br />
        Please enable JavaScript to view the <a href="https://github.com/hotoo/blog.hotoo.me/issues">comments powered by Gitment.</a>
      </noscript>
    </section>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script type="text/javascript">
    
    var disqus_identifier = "weekly-topic-about-exceptions-4";
    

    var gitment = new Gitment({
      id: disqus_identifier, // 可选。默认为 location.href
      owner: 'hotoo',
      repo: 'blog.hotoo.me',
      oauth: {
        client_id: '2ac185fc670562ffa0aa',
        client_secret: '248f4f2d70ed28b1e3e70113db27d46067a981a8',
      },
    })
    gitment.render('disqus_thread');

    // var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    // dsq.src = 'http://hotoo.disqus.com/embed.js';
    // (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  </script>
</div>
</div>

    <!-- Vimlike status bar -->
    <div id="status-bar">
        <span id="count"></span>
    </div>
</div>
<div id="helper-box"></div>
<div id="helper" tabindex="1">
    <table>
    <thead>
        <tr>
            <th colspan="2">Help</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th width="120">[count]gg</th>
            <td>跳转到第 [count] 行，默认第 1 行。</td>
        </tr>
        <tr>
            <th>[count]G</th>
            <td>跳转到第 [count] 行，默认最后一行。</td>
        </tr>
        <tr>
            <th>[count]j</th>
            <td>向下跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>[count]k</th>
            <td>向上跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>/</th>
            <td>开始搜索。按 &lt;Esc&gt; 退出。</td>
        </tr>
        <tr>
            <th>gh</th>
            <td>跳转到首页。</td>
        </tr>
        <tr>
            <th>gb</th>
            <td>跳转到博客首页。</td>
        </tr>
        <tr>
            <th>gw</th>
            <td>跳转到 Wiki 首页。</td>
        </tr>
        <tr>
            <th>gt</th>
            <td>跳转到我的 Twitter Profile 页。</td>
        </tr>
        <tr>
            <th>gp</th>
            <td>跳转到我的 Github Profile 页。</td>
        </tr>
        <tr>
            <th>?</th>
            <td>打开帮助。按 &lt;Esc&gt; 退出。</td>
        </tr>
    </tbody>
    </table>
</div>

<script type="text/javascript" src="/static/js/Vimlike.js"></script>
<footer>
  <p><a rel="license" href="http://creativecommons.org/licenses/by/2.5/"><img
    alt="Creative Commons License" style="border-width: 0pt;"
    src="http://i.creativecommons.org/l/by/2.5/88x31.png" align="right"/></a>
  This work is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/2.5/">Creative
    Commons Attribution 2.5 Generic License</a>.<br/>
  Copyleft &copy; 2005-2013, Power by
  <a href="http://lab.lepture.com/nico/">nico@0.5.2</a>, Theme by 闲耘™(@hotoo).
  </p>
</footer>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2048484-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>