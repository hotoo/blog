<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<!--[if IE]><script type="text/javascript" src="/js/html5.js"></script><![endif]-->
<meta charset="UTF-8" />
<meta name="generator" content="gvim" />
<meta name="author" content="闲耘 (hotoo.cn[AT]gmail.com)" />
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<!--<link rel="alternate" type="application/rss+xml" title="RSS"
  href="http://vimcn.blogspot.com/feeds/posts/default?alt=rss" />-->
<link rel="alternate" type="application/atom+xml" title="Atom" href="/atom.xml" />
<link type="text/css" rel="stylesheet" href="/css/template.css" />
<script type="text/javascript" src="/js/sea.js"></script>
<script type="text/javascript">
seajs.config({
  alias: {
    'jquery': 'jquery-1.8.3.min.js',
    'hashchange': 'jquery.ba-hashchange.min.js'
  }
});
seajs.use(["jquery", "default-main"], function(){
    alert("default")
});
</script>
<title>JavaScript 块级作用域的变量定义 - 闲耘™.博客</title>
</head>
<body>
<div id="wrapper">
<header>
<div style="float:right;">
    <form action="search.html" id="searchbox" onsubmit="return onSearch();">
        <input type="text" name="q" />
        <input type="submit" value="搜索" />
    </form>
</div>
<nav>
    <ul>
        <li class="first"><a href="http://hotoo.me/" title="Home">Home</a></li>
        <li class="actived"><a href="/" title="Blog">Blog</a></li>
        <li><a href="http://wiki.hotoo.me/" title="Wiki">Wiki</a></li>
        <li><a href="http://wiki.hotoo.me/Vim.html" title="Vim">Vim</a></li>
        <li><a href="http://twitter.hotoo.me/" title="Twitter">Twitter</a></li>
        <li class="last"><a href="/projects.html" title="Project">Project</a></li>
        <!-- li class="last"><a href="../resume/resume.html" title="About Me">README</a></li -->
    </ul>
</nav>
</header>
<div id="container">
  <div id="content">
        <h1>JavaScript 块级作用域的变量定义</h1>
    <article>
        <blockquote><p>代码是写给人看的，顺便给机器执行。</p></blockquote>

<p>上周有位前端同学周报里分享了段 for 循环的『好代码』：</p>

<pre><code>for (var i = 0, item; item = list[i]; i++) {
  // 将 ltem = list[i]当做条件判断语句，当i下标溢出时，返回undefined，循环结束
  // 居然省了一个变量呢～
}
</code></pre>

<p>这位同学是看了 jQuery 里类似下面这种用法之后做的这个分享：</p>

<pre><code>// If no nodeType, this is expected to be an array
for ( ; (node = elem[i]); i++ ) {
    // Do not traverse comment nodes
    ret += getText( node );
}
</code></pre>

<p>jQuery 还有不少地方使用这种用法，也有不少地方是传统的使用 length 方法。
但是 jQuery 这样用有其特定场景，需要正视。我回复说：</p>

<ol>
<li>如果数组项中有 0, false, null, undefined, ""，代码就出 bug 了。</li>
<li>好像没看到少了变量，一定要少的话，典型的 for 写法也可以少（但是不推荐）。</li>
<li>代码是写给人读的，顺便给机器执行。</li>
<li>另外，对 list 本身有操作，尤其是长度有影响的操作要特别注意。</li>
</ol>


<p>我个人推荐下面这种写法：</p>

<pre><code>for(var i=0,l=list.length; i&lt;l; i++){
  list[i]
}
</code></pre>

<p>Vim snipMate 代码片段模板里这样写：</p>

<pre><code>snippet for
    for(var ${1:i}=0,${2:l}=${3:list}.length; $1&lt;$2; $1${4:++}){
        ${5:$3[$1]}
    }
snippet forr
    for(var ${1:i}=${2:list}.length-1; $1&gt;=0; $1--){
        ${3:$2[$1]}
    }
snippet forin
    for(var ${1:k} in ${2:obj}){
        ${3:$2[$1]}
    }
</code></pre>

<hr />

<p>好了，使用溢出判断数组循环结束的讨论到此结束了。但是由于 JavaScript 作用域的问题，
有同学建议说将 <code>i</code>, <code>l</code> 变量定义在 <code>for</code> 循环之外。</p>

<p>于是进入另一个变量定义的话题。</p>

<p>持有变量应前置定义观点的同学，估计有不少是受了《JavaScript 权威指南》或其他权威著作的影响。</p>

<p>《JavaScript 权威指南》第 4 章 4.3.1 小节 [1] 详细分析了块级作用域中变量定义的问题，</p>

<p>JavaScript 只有函数作用域，没有块级作用域，因此在 <code>for</code>, <code>if/else</code>, <code>do/while</code>, <code>switch/case</code>
这些块中定义的变量，实际在块之外也可以使用。</p>

<p>这是 JavaScript 设计的 BUG，所以书中作者建议将所有变量声明集中放置在函数开头，
说这是个好习惯。</p>

<blockquote><p>In programming languages with block scope, it is generally good programming
practice to declare variables as close as possible to where they are used and
with the narrowest possible scope. Since JavaScript does not have block scope,
some programmers make a point of declaring all their variables at the top of
the function, rather than trying to declare them closer to the point at which
they are used. This technique makes their source code accurately reflect the
true scope of the variables.</p></blockquote>

<hr />

<p>但是这个我稍微持不同的观点 ：）</p>

<p>实际上我们定义 <code>i</code>, <code>l</code> 是为了给 <code>for</code> 用的，JavaScript 解释器在执行的时候可以
给块级作用域外面用，不代表就应该定义在外面。</p>

<p>定义在外面给人的暗示是这个变量是给整个 function 用的，而不只是 for 循环，
就会给人『在外面用也没关系』的感觉。但这其实不是我们定义 <code>i</code>, <code>l</code> 的本意。</p>

<p>而且前置定义导致变量声明和实际变量使用两种分离，不直观，而且容易误清理、
或遗漏清理变量声明。</p>

<p>对于 JavaScript 的这个糟粕，让人来适应机器的问题而修改代码，甚至改变本性习惯，
和另一个分号的话题是何其的相似。</p>

<p>那么为什么不让机器来适应人，在 IDE 中编辑代码、或编译 JavaScript 代码时发现有
for 之外有使用 for 内部定义的变量时，给予恰当的警告。这样是否更合理呢。</p>

<p>如果遵循权威的教诲，把变量定义在函数前面，编辑器和编译器都没有办法帮我们了。</p>

<p>我认为：</p>

<ol>
<li>定义在块级作用域的变量不应该被块级作用域之外使用。</li>
<li>如果被块之外使用了：

<ol>
<li>要么这是一个错误的用法，会带来隐患。人、编辑器、编译器可以看出来并给出警告。</li>
<li>或者有这样的使用需求，那么你这个应该被声明在块级作用域之外。</li>
</ol>
</li>
</ol>


<p>所以我比较认同 <code>就近定义</code> 这种更合理、更人性的风格。</p>

<h2>最后</h2>

<p>那么，请问你持什么样的观点呢？</p>

<h2>备注</h2>

<ol>
<li>《JavaScript 权威指南》第六版章节和标题有所变更。第六版对应章节在第 3 章
 第 3.10.1 小节：函数作用域和声明提前。</li>
</ol>


    </article>
    <footer class="post clearfix">
      <span class="tags">
        tags:
        
          
          <a href="/tags.html#JavaScript">JavaScript</a>
        
      </span>
      <time>April 25, 
      <a href="/archives.html#2013">2013</a>
    </footer>
    <section>
        <div id="disqus_thread"></div>
        <noscript>
        要查看或参与评论，请启用 JavaScript 支持。<br />
        Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=hotoo">comments powered by Disqus.</a>
        </noscript>
    </section>
<script type="text/javascript" src="/js/comments.js"></script>

  </div>

    <!-- Vimlike status bar -->
    <div id="status-bar">
        <span id="count"></span>
    </div>
</div>
<div id="helper-box"></div>
<div id="helper" tabindex="1">
    <table>
    <thead>
        <tr>
            <th colspan="2">Help</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th width="120">[count]gg</th>
            <td>跳转到第 [count] 行，默认第 1 行。</td>
        </tr>
        <tr>
            <th>[count]G</th>
            <td>跳转到第 [count] 行，默认最后一行。</td>
        </tr>
        <tr>
            <th>[count]j</th>
            <td>向下跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>[count]k</th>
            <td>向上跳转 [count] 行，默认跳转一行。</td>
        </tr>
        <tr>
            <th>/</th>
            <td>开始搜索。按 &lt;Esc&gt; 退出。</td>
        </tr>
        <tr>
            <th>gh</th>
            <td>跳转到首页。</td>
        </tr>
        <tr>
            <th>gb</th>
            <td>跳转到博客首页。</td>
        </tr>
        <tr>
            <th>gw</th>
            <td>跳转到 Wiki 首页。</td>
        </tr>
        <tr>
            <th>gt</th>
            <td>跳转到我的 Twitter Profile 页。</td>
        </tr>
        <tr>
            <th>gp</th>
            <td>跳转到我的 Github Profile 页。</td>
        </tr>
        <tr>
            <th>?</th>
            <td>打开帮助。按 &lt;Esc&gt; 退出。</td>
        </tr>
    </tbody>
    </table>
</div>

<script type="text/javascript" src="/js/Vimlike.js"></script>
<footer>
    <p><a rel="license" href="http://creativecommons.org/licenses/by/2.5/"><img alt="Creative Commons License" style="border-width: 0pt;" src="http://i.creativecommons.org/l/by/2.5/88x31.png" align="right"></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/2.5/">Creative Commons Attribution 2.5 Generic License</a>.<br>
    Copyleft &copy; 2005-2010, Power by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>, Theme by 闲耘™(@hotoo).
    </p>
</footer>
</div>
<script type="text/javascript">
var gaJsHost=(("https:"==document.location.protocol)?"https://ssl.":"http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker=_gat._getTracker("UA-2048484-1");
pageTracker._trackPageview();
}catch(err){}</script>
</body>
</html>
